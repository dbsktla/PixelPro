<!DOCTYPE html>
<html lang="en"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{common/mylayout}">
<th:block layout:fragment = "css">
    <link th:href="@{/css/main.css}" rel="stylesheet">
    <link href="//maxcdn.bootstrapcdn.com/bootstrap/4.1.1/css/bootstrap.min.css" rel="stylesheet" id="bootstrap-css">
</th:block>

<div class="content" layout:fragment="content" style = "height: 800px; padding: 60px 200px; margin-left: 240px; margin-top:50px;">
    <input type = "hidden" name = "mbnum" th:value = "${session.member.mbnum}">
    <div class="container">
        <div class="messaging">
            <div class="inbox_msg">
                <div class="inbox_people">
                    <div class="headind_srch">
                        <div class="recent_heading">
                            <h4>Recent</h4>
                        </div>
                        <div class="search_bar">
                            <div class="stylish-input-group">
                                <input type="text" class="search-bar"  placeholder="Search" >
                                <span class="input-group-addon">
                <button type="button"> <i class="bi bi-search" aria-hidden="true"></i> </button>
                </span> </div>
                        </div>
                    </div>
                    <div class="inbox_chat" id = "inbox">

                        <!-- 대화 목록 들어가는 부분 --!>
                    </div>
                </div>
                <div class="mesgs">
                    <input type = "hidden" name = "cnum" value = "1">
                    <div class="msg_history" id = "msg_history">
                        <!--메시지를 들어가는 부분-->
                    </div>
                    <div class="type_msg">
                        <div class="input_msg_write">
                            <input type="text" name = "mcontent" class="write_msg"/>
                            <button class="msg_send_btn" type="button" onclick = "sendMessage()"><i class="bi bi-send-fill"></i></button>
                        </div>
                    </div>
                </div>
            </div>



        </div></div>
</div>
<th:block layout:fragment = "script">

    <script src="//maxcdn.bootstrapcdn.com/bootstrap/4.1.1/js/bootstrap.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <script
            src="https://code.jquery.com/jquery-3.3.1.min.js"
            integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="
            crossorigin="anonymous"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.3.0/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
    <script>
$(document).ready(  function() {
	//connectWS();
	//connectSockJS();
	console.log('Connected!');
	connectStomp(); //페이지 로딩 될때 stomp연결하는 함수 호출.

	$('.chatList').click(function(evt) {
	    $('.chatList').each(function(){
	        $(this).removeClass("active_chat");
	    });
	    $(this).addClass("active_chat");
        evt.preventDefault();
        if (!isStomp && socket.readyState !== 1) return;

        var id = $('input[id="name"]').val();
        if (isStomp) {

        } else {

        }
    });
});

var socket = null;
var isStomp = false;

function connectStomp() { //연결해주는 함수
	var sock = new SockJS("/stompTest"); // endpoint 맞아야된다! config파일에 지정된거
    var client = Stomp.over(sock);
	isStomp = true;
	socket = client;

    client.connect({}, function () { //연결!
        console.log("Connected stompTest!");
        // Controller's MessageMapping, header, message(자유형식)
        var mbnum = $('input[name="mbnum"]').val();
        console.log("mbnum", mbnum);
        client.send('/chat/conversation', {}, mbnum);
        // 해당 토픽을 구독한다!
        client.subscribe('/topic/conversation/' + mbnum, function(event){
            console.log("event:" , event);
            var data = JSON.parse(event.body);
            console.log("data:", data)
            var messageTemplateHTML = "";
            var i = 1;
            $.each(data, function(){
                messageTemplateHTML = '<a href = "#" class = "chatList"'
                                    + '><div class="chat_list" id = "chat' + i + '" onclick = "highlight(' + i + ')">'
                                    + '<div class="chat_people">'
                                    + '<div class="chat_ib">'
                                    + '<h5>대화명: ' + this.cname +  '<span class="chat_date">안 읽은 메시지 수 : ' + this.unreadCount+ ' </span></h5>'
                                    + '<p>' + this.recentSenderName  + ' : ' + '"' + this.recentMsg +  '"' + '</p></div></div></div></a>';
                $('#inbox').append(messageTemplateHTML);
                i++;
            });

        }); //subscribe

        client.subscribe('topic/receiveMessage/' + mbnum, function(event){
            var data = JSON.parse(event.body);
            console("receiveData", data);
            //원래 선택 되어있던 대화번호.
            var cnum = $('input[name="cnum"]').val();
            highlight(data.cnum);
            client.send('/chat/conversation/', {}, mbnum);
            var selected = document.getElementById("chat" + data.cnum);
            var sendData = mbnum + "/" + data.cnum; //보낼 직원 번호, 대화번호 합쳐서 보낸다. MessageMapping에는 세션 접근 불가능
            client.send('/chat/message', {}, sendData);
        }); //subscribe
    });
}

function highlight(num){ //대화 선택시 실행되는 함수,
    //색갈 변견해준다
    var chatList = document.getElementsByClassName("chat_list");
    var selected = document.getElementById("chat" + num);
    for(i = 0; i < chatList.length; i++){
        chatList[i].classList.remove("active_chat");
    }
    selected.classList.add("active_chat");
    console.log("chatList", chatList);
    $('input[name=cnum]').val(num);

    //대화를 가져오기.
    $('#msg_history').empty();
    var mbnum = $('input[name="mbnum"]').val();
    var sendData = mbnum + "/" + num; //보낼 직원 번호, 대화번호 합쳐서 보낸다. MessageMapping에는 세션 접근 불가능
    socket.send('/chat/message', {}, sendData);

    socket.subscribe('/topic/message/' + mbnum, function(event){
        var data = JSON.parse(event.body);
        console.log("message Data:" , data);
        var messageBoxHtml = "";
        $.each(data, function(){
            var loginName = this.loginName;
            if(this.sender == this.loginName){ //메시지 보낸 이름이 본인 인지
                messageBoxHtml += '<div class="outgoing_msg"><div class="sent_msg"><p>'
                                + this.mcontent
                                + '</p><span class="time_date">'
                              + this.mtime
                              + '<br>' + this.sender + ' (' + this.mblevel + ')'
                                + '</span></div></div>';
            } else {
                messageBoxHtml += '<div class="incoming_msg"><div class="incoming_msg_img"></div><div class="received_msg"><div class="received_withd_msg"><p>'
                                + this.mcontent
                                + '</p><span class="time_date">'
                                + this.mtime
                                + '<br>' + i + this.sender + ' (' + this.mblevel + ')'
                                + '</span></div></div>';
            }
        });
        $('#msg_history').html(messageBoxHtml);
    });
}

function sendMessage(){ //메시지 보내는 함수
    var mbnum = $('input[name="mbnum"]').val();
    //현재 선택된 대화번호
    var cnum = $('input[name="cnum"]').val();
    var mcontent = $('input[name="mcontent"]').val();
    var sendData = mbnum + "/" + cnum + "/" + mcontent;
    socket.send('/chat/sendMessage', {}, sendData);
}
</script>
</th:block>
</html>